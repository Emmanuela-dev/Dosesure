# Firebase Integration Guide for DoseSure

## Overview

Your DoseSure app is now integrated with Firebase! This document explains how the Firebase integration works and how to use it.

## Architecture

### Services Layer

#### 1. FirebaseAuthService (`lib/services/firebase_auth_service.dart`)
Handles all authentication operations:
- User registration with email/password
- User login
- Password reset
- Sign out
- Account deletion
- Error handling for Firebase Auth exceptions

#### 2. FirestoreService (`lib/services/firestore_service.dart`)
Manages all database operations:
- **Users**: CRUD operations for user profiles
- **Medications**: Add, update, delete, and stream medications
- **Dose Logs**: Track medication adherence
- **Side Effects**: Record and monitor side effects
- **Herbal Uses**: Manage herbal supplement information
- **Analytics**: Calculate adherence rates and statistics

### Providers

#### AuthProvider (Updated)
- Manages authentication state
- Loads and caches clinician list from Firestore
- Handles user registration with doctor assignment
- Provides loading states for UI feedback
- Automatically syncs with Firebase Auth state

#### HealthDataProvider (Updated)
- Real-time data synchronization using Firestore streams
- Automatically updates UI when data changes in the database
- Manages subscriptions to prevent memory leaks
- Provides loading states for operations

## Data Structure

### Firestore Collections

```
users/
  {userId}/
    - id: string
    - name: string
    - email: string
    - role: int (0 = clinician, 1 = patient)
    - doctorId: string (nullable)

medications/
  {medicationId}/
    - id: string
    - userId: string
    - name: string
    - dosage: string
    - frequency: string
    - times: array<string>
    - instructions: string
    - startDate: timestamp
    - endDate: timestamp (nullable)
    - isActive: boolean
    - createdAt: timestamp

doseLogs/
  {doseLogId}/
    - id: string
    - userId: string
    - medicationId: string
    - scheduledTime: timestamp
    - takenTime: timestamp (nullable)
    - taken: boolean
    - notes: string (nullable)
    - createdAt: timestamp

sideEffects/
  {sideEffectId}/
    - id: string
    - userId: string
    - medicationId: string
    - description: string
    - severity: int (1-5)
    - reportedDate: timestamp
    - notes: string (nullable)
    - createdAt: timestamp

herbalUses/
  {herbalUseId}/
    - id: string
    - userId: string
    - name: string
    - dosage: string
    - frequency: string
    - purpose: string
    - startDate: timestamp
    - endDate: timestamp (nullable)
    - isActive: boolean
    - notes: string (nullable)
    - createdAt: timestamp
```

## Usage Examples

### Registration

```dart
final authProvider = Provider.of<AuthProvider>(context, listen: false);

try {
  await authProvider.register(
    name: 'John Doe',
    email: 'john@example.com',
    password: 'securePassword123',
    role: UserRole.patient,
    doctorName: 'Dr. Smith', // Optional
  );
  // Navigate to home screen
} catch (e) {
  // Show error message
  print('Registration error: $e');
}
```

### Login

```dart
final authProvider = Provider.of<AuthProvider>(context, listen: false);

try {
  await authProvider.login(
    email: 'john@example.com',
    password: 'password123',
    role: UserRole.patient,
  );
  // Navigate to home screen
} catch (e) {
  // Show error message
  print('Login error: $e');
}
```

### Adding a Medication

```dart
final healthProvider = Provider.of<HealthDataProvider>(context, listen: false);
final authProvider = Provider.of<AuthProvider>(context, listen: false);

final medication = Medication(
  id: '', // Will be generated by Firestore
  name: 'Aspirin',
  dosage: '100mg',
  frequency: 'Once daily',
  times: ['08:00'],
  instructions: 'Take with food',
  startDate: DateTime.now(),
  isActive: true,
);

try {
  await healthProvider.addMedication(
    authProvider.currentUser!.id,
    medication,
  );
  // Medication added successfully
} catch (e) {
  print('Error adding medication: $e');
}
```

### Logging a Dose

```dart
final doseLog = DoseLog(
  id: '', // Will be generated by Firestore
  medicationId: medicationId,
  scheduledTime: scheduledTime,
  takenTime: DateTime.now(),
  taken: true,
  notes: 'Took with breakfast',
);

await healthProvider.logDose(
  authProvider.currentUser!.id,
  doseLog,
);
```

### Real-time Data Updates

The providers automatically listen to Firestore changes. To initialize:

```dart
@override
void initState() {
  super.initState();
  
  final authProvider = Provider.of<AuthProvider>(context, listen: false);
  final healthProvider = Provider.of<HealthDataProvider>(context, listen: false);
  
  if (authProvider.currentUser != null) {
    healthProvider.initializeForUser(authProvider.currentUser!.id);
  }
}
```

### Displaying Medications

```dart
Consumer<HealthDataProvider>(
  builder: (context, healthProvider, child) {
    if (healthProvider.isLoading) {
      return CircularProgressIndicator();
    }
    
    final medications = healthProvider.medications;
    
    if (medications.isEmpty) {
      return Text('No medications');
    }
    
    return ListView.builder(
      itemCount: medications.length,
      itemBuilder: (context, index) {
        final med = medications[index];
        return ListTile(
          title: Text(med.name),
          subtitle: Text('${med.dosage} - ${med.frequency}'),
        );
      },
    );
  },
)
```

## Security Considerations

### Current Setup (Development)
The app uses Firebase Auth for authentication and Firestore for data storage. You should configure Firestore Security Rules before deploying to production.

### Recommended Security Rules

See `FIREBASE_SETUP.md` for detailed security rules. Key points:

1. **Authentication Required**: All operations require authentication
2. **User Isolation**: Users can only access their own data
3. **Clinician Access**: Clinicians can read their patients' data
4. **Write Protection**: Users can only write to their own documents

## Testing

### Before Firebase Configuration

The app will run but Firebase features won't work. You'll see console warnings about Firebase initialization.

### After Firebase Configuration

1. Create a clinician account first (for testing patient registration)
2. Test patient registration with doctor assignment
3. Verify data appears in Firestore Console
4. Test real-time updates by modifying data in Firestore Console

## Migration from Mock Data

If you have existing screens using mock data:

1. **Replace direct list access** with Provider consumers
2. **Update method signatures** to include `userId` parameter
3. **Handle async operations** with try-catch blocks
4. **Show loading states** using `isLoading` property
5. **Initialize listeners** in screen's `initState()`

Example migration:

```dart
// Before
void addMedication(Medication med) {
  healthProvider.addMedication(med);
}

// After
Future<void> addMedication(Medication med) async {
  try {
    await healthProvider.addMedication(
      authProvider.currentUser!.id,
      med,
    );
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Medication added successfully')),
    );
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Error: $e')),
    );
  }
}
```

## Troubleshooting

### "Firebase not initialized" errors
- Run `flutterfire configure` to generate configuration
- Check that `firebase_options.dart` has valid credentials

### Data not appearing
- Check Firestore Security Rules
- Verify user is authenticated
- Check console for errors
- Verify `initializeForUser()` is called

### Authentication errors
- Check Firebase Console â†’ Authentication is enabled
- Verify Email/Password provider is enabled
- Check error messages in catch blocks

## Performance Tips

1. **Limit queries**: Use pagination for large datasets
2. **Index fields**: Add indexes in Firestore for complex queries
3. **Dispose subscriptions**: The provider handles this automatically
4. **Cache data**: Use `shared_preferences` for frequently accessed data
5. **Offline support**: Firestore has built-in offline support

## Next Steps

1. Configure Firebase (see `FIREBASE_SETUP.md`)
2. Update screens to use Firebase-backed providers
3. Test registration and login flows
4. Verify data persistence
5. Set up Firestore Security Rules
6. Test offline functionality
7. Add error handling throughout the app

## Support

For questions or issues:
- Check Firebase Console for errors
- Review Firestore Security Rules
- Check authentication state
- Review provider initialization
